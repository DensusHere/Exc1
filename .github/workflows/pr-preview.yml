name: PR Preview

on:
  pull_request:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Cache node modules
        id: cache
        uses: actions/cache@v2
        with:
          path: node_modules
          key: cache-node-modules-${{ hashFiles('package-lock.json') }}
      - name: Cache Cypress
        id: cypress-cache
        uses: actions/cache@v2
        with:
          path: /home/runner/.cache/Cypress
          key: cache-cypress-${{ hashFiles('package-lock.json') }}
      - name: npm install
        if: steps.cache.outputs.cache-hit != 'true' || steps.cypress-cache.outputs.cache-hit != 'true'
        run: npm i
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - name: Build Code Examples
        run: npx nx run code-examples:build --base-href /skyux-pr-preview/${{ github.event.number }}/apps/code-examples/
      - name: Build Playground
        run: npx nx run playground:build --base-href /skyux-pr-preview/${{ github.event.number }}/apps/playground/
      - name: Build Storybook
        run: |
          npx nx affected --target=build-storybook
          npx nx run storybook:build-storybook
          for sb in dist/storybook/*
          do
            npx sb extract $sb
          done
      - uses: actions/checkout@v3
        with:
          repository: 'blackbaud/skyux-pr-preview'
          ref: 'main'
          fetch-depth: 1
          path: skyux-pr-preview
          token: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}
      - name: Remove old PR builds
        run: |
          set -x
          ls ./skyux-pr-preview | grep -E '^[0-9]+$' | sort > ${{ runner.temp }}/current_builds.txt
          gh pr list -q '.[] | .number' --state open --json number | tr -d ' ' | sort > ${{ runner.temp }}/expected_builds.txt
          if [[ -s "${{ runner.temp }}/current_builds.txt" && -s "${{ runner.temp }}/expected_builds.txt" ]]
          then
            # Get current builds that are not in expected.
            comm -23 ${{ runner.temp }}/current_builds.txt ${{ runner.temp }}/expected_builds.txt | tr -d ' ' > ${{ runner.temp }}/old_builds.txt
            if [[ -s "${{ runner.temp }}/old_builds.txt" ]]
            then
              git -C ./skyux-pr-preview rm -r -f --pathspec-from-file=${{ runner.temp }}/old_builds.txt
            else
              echo "All builds are current"
            fi
          else
            echo "Nothing to remove"
          fi
        env:
          GITHUB_TOKEN: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}
      - name: Update PR build
        run: |
          set -x
          rm -rf ./skyux-pr-preview/${{ github.event.number }}
          mkdir -p ./skyux-pr-preview/${{ github.event.number }}/storybooks
          cp -R ./dist/apps ./skyux-pr-preview/${{ github.event.number }}/
          cp -R ./dist/storybook/storybook ./skyux-pr-preview/${{ github.event.number }}/
          for sb in ./dist/storybook/*
          do
            if [[ "${sb}" != "./dist/storybook/storybook" ]]
            then
              cp -R $sb ./skyux-pr-preview/${{ github.event.number }}/storybooks/$(basename $sb)
            fi
          done
      - name: Commit build to GH Pages
        run: |
          set -x
          git config --global user.name "Blackbaud Sky Build User"
          git config --global user.email "sky-build-user@blackbaud.com"
          git -C ./skyux-pr-preview add --all
          git -C ./skyux-pr-preview status
          if [[ -n "$(git -C ./skyux-pr-preview status -s)" ]]
          then
            git -C ./skyux-pr-preview commit -m "$(printf 'skyux %b%d commit %s' '\043' ${{ github.event.number }} ${GITHUB_SHA:0:8})"
            git -C ./skyux-pr-preview push
          else
            echo "No changes"
          fi
      - name: Comment on PR
        run: |
          echo "[Storybook preview](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybook/) for $(printf '%b%d' '\043' ${{ github.event.number }})" > ${{ runner.temp }}/pr_comment.txt
          echo >> ${{ runner.temp }}/pr_comment.txt
          echo 'Component Storybooks:' >> ${{ runner.temp }}/pr_comment.txt
          echo >> ${{ runner.temp }}/pr_comment.txt
          for path in ./skyux-pr-preview/${{ github.event.number }}/apps/*
          do
            if [[ "$(basename $path)" != "storybook" ]]
            then
              echo "- [$(basename $path)](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/$(basename $path)/)" >> ${{ runner.temp }}/pr_comment.txt
            fi
          done
          echo >> ${{ runner.temp }}/pr_comment.txt
          echo 'App previews:' >> ${{ runner.temp }}/pr_comment.txt
          echo >> ${{ runner.temp }}/pr_comment.txt
          for path in ./skyux-pr-preview/${{ github.event.number }}/apps/*
          do
            echo "- [$(basename $path)](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/apps/$(basename $path)/)" >> ${{ runner.temp }}/pr_comment.txt
          done
          COMMENT_ID="$(gh api -H "Accept: application/vnd.github.v3+json" /repos/blackbaud/skyux/issues/${{ github.event.number }}/comments | jq -r '.[] | select(.body | startswith("[Storybook preview]")) | .id')"
          set -x
          cat ${{ runner.temp }}/pr_comment.txt
          echo && echo
          if [[ -z "${COMMENT_ID}" ]]
          then
            gh pr comment ${{ github.event.number }} -F ${{ runner.temp }}/pr_comment.txt
          else
            set +x
            jq -r --null-input --arg body "$(cat ${{ runner.temp }}/pr_comment.txt)" '{"body": $body}' > ${{ runner.temp }}/pr_comment.json
            set -x
            cat ${{ runner.temp }}/pr_comment.json | jq
            echo && echo
            gh api --method PATCH -H "Accept: application/vnd.github.v3+json" /repos/blackbaud/skyux/issues/comments/${COMMENT_ID} --input ${{ runner.temp }}/pr_comment.json
          fi
        env:
          GITHUB_TOKEN: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}
      - name: Percy Storybook
        run: npx percy storybook https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN}}
      - name: Percy e2e
        run: npx percy exec -- nx run indicators-e2e:e2e --skip-nx-cache
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_E2E}}
