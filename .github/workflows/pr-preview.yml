name: PR Preview

on:
  pull_request:

env:
  NX_CLOUD_DISTRIBUTED_EXECUTION: false
  PERCY_POSTINSTALL_BROWSER: true

jobs:
  install-deps:
    name: Install and cache dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Cache dependencies
        id: cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: npm install
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          set -x
          node ./scripts/rebase-pr.js
          npm ci

  build-storybook:
    name: Build Storybook
    needs: install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Retrieve dependencies cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: Retrieve nx cache
        uses: actions/cache@v2
        with:
          path: node_modules/.cache/nx
          key: cache-nx-storybook-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            cache-nx-storybook-
            cache-nx-
      - name: Rebase current branch
        run: node ./scripts/rebase-pr.js
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - name: Build Storybook
        run: npx nx affected --target=build-storybook --configuration=ci --parallel=5 --exclude=storybook
      - name: Upload storybook artifact
        uses: actions/upload-artifact@v3
        with:
          name: storybook
          path: ./dist/storybook
          retention-days: 1
          if-no-files-found: error

  build-code-examples:
    name: Build Code Examples
    needs: install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Retrieve dependencies cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: Retrieve nx cache
        uses: actions/cache@v2
        with:
          path: node_modules/.cache/nx
          key: cache-nx-code-examples-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            cache-nx-code-examples-
            cache-nx-
      - name: Rebase current branch
        run: node ./scripts/rebase-pr.js
      - name: Build Code Examples
        run: npx nx run code-examples:build --baseHref /skyux-pr-preview/${{ github.event.number }}/apps/code-examples/
      - name: Upload code-examples artifact
        uses: actions/upload-artifact@v3
        with:
          name: code-examples
          path: ./dist/apps/code-examples
          retention-days: 1
          if-no-files-found: error

  build-playground:
    name: Build Playground
    needs: install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Retrieve dependencies cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: Retrieve nx cache
        uses: actions/cache@v2
        with:
          path: node_modules/.cache/nx
          key: cache-nx-playground-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            cache-nx-playground-
            cache-nx-
      - name: Rebase current branch
        run: node ./scripts/rebase-pr.js
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - name: Build Playground
        run: npx nx run playground:build --baseHref /skyux-pr-preview/${{ github.event.number }}/apps/playground/
      - name: Upload playground artifact
        uses: actions/upload-artifact@v3
        with:
          name: playground
          path: ./dist/apps/playground
          retention-days: 1
          if-no-files-found: error

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs:
      - build-code-examples
      - build-playground
      - build-storybook
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Retrieve dependencies cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: Retrieve nx cache
        uses: actions/cache@v2
        with:
          path: node_modules/.cache/nx
          key: cache-nx-publish-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            cache-nx-publish-
            cache-nx-
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - name: Download code-examples artifact
        uses: actions/download-artifact@v3
        with:
          name: code-examples
          path: ./dist/apps/code-examples
      - name: Download playground artifact
        uses: actions/download-artifact@v3
        with:
          name: playground
          path: ./dist/apps/playground
      - name: Download storybook artifact
        uses: actions/download-artifact@v3
        with:
          name: storybook
          path: ./dist/storybook
      - name: Build Storybook Composition
        run: |
          set -x
          npx nx print-affected --target=build-storybook | jq -r '.projects | join(",")' > ${{ runner.temp }}/affected_projects.txt
          for sb in ./dist/storybook/*
          do
            npx sb extract $sb
          done
          npx nx workspace-generator storybook-composition "$(<${{ runner.temp }}/affected_projects.txt)" --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/
          npx nx run storybook:build-storybook:ci
      - name: Create preview README.md
        run: |
          echo "# Sky UX Pull Request Preview" > ${{ runner.temp }}/README.md
          echo "" >> ${{ runner.temp }}/README.md
          echo "Preview build for [PR #${{ github.event.number }}](https://github.com/blackbaud/skyux/pull/${{ github.event.number }})" >> ${{ runner.temp }}/README.md
          echo "" >> ${{ runner.temp }}/README.md
          echo "[Storybook preview](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybook/)" > ${{ runner.temp }}/pr_comment.md
          echo "" >> ${{ runner.temp }}/pr_comment.md
          echo 'Component Storybooks:' >> ${{ runner.temp }}/pr_comment.md
          echo "" >> ${{ runner.temp }}/pr_comment.md
          for dist in ./dist/storybook/*
          do
            if [[ "$(basename $dist)" != "storybook" ]]
            then
              echo "- [$(basename $dist)](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/$(basename $dist)/)" >> ${{ runner.temp }}/pr_comment.md
            fi
          done
          echo "" >> ${{ runner.temp }}/pr_comment.md
          echo 'App previews:' >> ${{ runner.temp }}/pr_comment.md
          echo "" >> ${{ runner.temp }}/pr_comment.md
          for dist in ./dist/apps/*
          do
            echo "- [$(basename $dist)](https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/apps/$(basename $dist)/)" >> ${{ runner.temp }}/pr_comment.md
          done
          cat ${{ runner.temp }}/pr_comment.md >> ${{ runner.temp }}/README.md
      - uses: actions/checkout@v3
        with:
          repository: 'blackbaud/skyux-pr-preview'
          ref: 'main'
          fetch-depth: 1
          path: skyux-pr-preview
          token: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}
      - name: Remove old PR builds
        run: |
          set -x
          ls ./skyux-pr-preview | grep -E '^[0-9]+$' | sort > ${{ runner.temp }}/current_builds.txt
          gh pr list -q '.[] | .number' --state open --json number | tr -d ' ' | sort > ${{ runner.temp }}/expected_builds.txt
          if [[ -s "${{ runner.temp }}/current_builds.txt" && -s "${{ runner.temp }}/expected_builds.txt" ]]
          then
            # Get current builds that are not in expected.
            comm -23 ${{ runner.temp }}/current_builds.txt ${{ runner.temp }}/expected_builds.txt | tr -d ' ' > ${{ runner.temp }}/old_builds.txt
            if [[ -s "${{ runner.temp }}/old_builds.txt" ]]
            then
              git -C ./skyux-pr-preview rm -r -f --pathspec-from-file=${{ runner.temp }}/old_builds.txt
            else
              echo "All builds are current"
            fi
          else
            echo "Nothing to remove"
          fi
        env:
          GITHUB_TOKEN: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}
      - name: Update PR build
        run: |
          set -x
          rm -rf ./skyux-pr-preview/${{ github.event.number }}
          mkdir -p ./skyux-pr-preview/${{ github.event.number }}/storybooks
          mv ${{ runner.temp }}/README.md ./skyux-pr-preview/${{ github.event.number }}/
          cp -R ./dist/apps ./skyux-pr-preview/${{ github.event.number }}/
          cp -R ./dist/storybook/storybook ./skyux-pr-preview/${{ github.event.number }}/
          for sb in ./dist/storybook/*
          do
            if [[ "${sb}" != "./dist/storybook/storybook" ]]
            then
              cp -R $sb ./skyux-pr-preview/${{ github.event.number }}/storybooks/$(basename $sb)
            fi
          done
      - name: Commit build to GH Pages
        run: |
          set -x
          git config --global user.name "Blackbaud Sky Build User"
          git config --global user.email "sky-build-user@blackbaud.com"
          git -C ./skyux-pr-preview add --all
          git -C ./skyux-pr-preview status
          if [[ -n "$(git -C ./skyux-pr-preview status -s)" ]]
          then
            git -C ./skyux-pr-preview commit -m "$(printf 'skyux %b%d commit %s' '\043' ${{ github.event.number }} ${GITHUB_SHA:0:8})"
            git -C ./skyux-pr-preview push
          else
            echo "No changes"
          fi
      - name: Comment on PR
        run: |
          set -x
          COMMENT_ID="$(gh api -H "Accept: application/vnd.github.v3+json" /repos/blackbaud/skyux/issues/${{ github.event.number }}/comments | jq -r '.[] | select(.body | startswith("[Storybook preview]")) | .id')"
          if [[ -z "${COMMENT_ID}" ]]
          then
            gh pr comment ${{ github.event.number }} -F ${{ runner.temp }}/pr_comment.md
          else
            jq -r --null-input --arg body "$(cat ${{ runner.temp }}/pr_comment.md)" '{"body": $body}' > ${{ runner.temp }}/pr_comment.json
            gh api --method PATCH -H "Accept: application/vnd.github.v3+json" /repos/blackbaud/skyux/issues/comments/${COMMENT_ID} --input ${{ runner.temp }}/pr_comment.json
          fi
        env:
          GITHUB_TOKEN: ${{secrets.GH_PERSONAL_ACCESS_TOKEN}}

  e2e:
    name: End to end tests
    runs-on: ubuntu-latest
    needs:
      - publish
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: Retrieve dependencies cache
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            !node_modules/.cache/nx
            /home/runner/.cache/Cypress
          key: cache-pr-preview-${{ hashFiles('package-lock.json') }}
      - name: Rebase current branch
        run: node ./scripts/rebase-pr.js
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - name: Get affected projects
        id: affected-projects
        run: |
          npx nx print-affected --target=build-storybook > ${{ runner.temp }}/affected_projects.json
          jq -r '.projects[]' ${{ runner.temp }}/affected_projects.json | xargs printf "::set-output name=run-%s::true\n"
      - name: Percy e2e indicators
        if: ${{ steps.affected-projects.outputs.run-indicators-e2e == 'true' }}
        run: npx percy exec -- nx run indicators-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/indicators/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_INDICATORS_E2E}}
      - name: Percy e2e ag-grid-storybook
        if: ${{ steps.affected-projects.outputs.run-ag-grid-storybook-e2e == 'true' }}
        run: npx percy exec -- nx run ag-grid-storybook-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/ag-grid-storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_AG_GRID_STORYBOOK_E2E}}
      - name: Percy e2e flyout-storybook
        if: ${{ steps.affected-projects.outputs.run-flyout-storybook-e2e == 'true' }}
        run: npx percy exec -- nx run flyout-storybook-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/flyout-storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_FLYOUT_STORYBOOK_E2E}}
      - name: Percy e2e lists-storybook
        if: ${{ steps.affected-projects.outputs.run-lists-storybook-e2e == 'true' }}
        run: npx percy exec -- nx run lists-storybook-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/lists-storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_LISTS_STORYBOOK_E2E}}
      - name: Percy e2e popovers-storybook
        if: ${{ steps.affected-projects.outputs.run-popovers-storybook-e2e == 'true' }}
        run: npx percy exec -- nx run popovers-storybook-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/popovers-storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_POPOVERS_STORYBOOK_E2E}}
      - name: Percy e2e tabs-storybook
        if: ${{ steps.affected-projects.outputs.run-tabs-storybook-e2e == 'true' }}
        run: npx percy exec -- nx run tabs-storybook-e2e:e2e:ci --skip-nx-cache --baseUrl https://blackbaud.github.io/skyux-pr-preview/${{ github.event.number }}/storybooks/tabs-storybook/
        env:
          PERCY_TOKEN: ${{secrets.PERCY_TOKEN_TABS_STORYBOOK_E2E}}
